extend "vacation/application/base"

import
  "git.x-lan.de/mavolin/vsys/pkg/morefmt"
  "git.x-lan.de/mavolin/vsys/repository"

  "time"

use
  //- add link to head for icons
  _ "base/icon"
  "base/component/modal"
  "base/component/menu"
  "base/element/button"
  "base/element/form"
  "base/element/table"

-
  type OthersRenderViewApplicationData struct {
      Days []ApplicationDay
      Self repository.Employee
      ID repository.ApplicationID
  }

  type ApplicationDay struct {
      Day time.Time

      Applied float32
      Applications []Application
  }

  type Application struct {
      Employee repository.Employee
  }

func RenderViewApplication(data othersViewApplicationData)

block main
  script
    | const data = [
    for _, day range data.Days
      | {day: new Date(#{day.Day.Format("2006-01-02")}), applied: #{day.Applied}, applications: [
      for _, a range day.Applications
        | {name: #{morefmt.EmployeeName(a.Employee))}, department: #{a.Employee.Department},
        | email: #{a.Employee.Email}, state: #{?a.State == nil("undefined" : a.State)}},
      | ]},
    | ];
    .
      let modal = document.getElementById("details-modal");
      let modalTitle = document.getElementById("details-modal-title");
      let modalBody = document.getElementById("details-modal-body");

      let calendarElem = document.getElementById("calendar);
      let calendar = new FullCalendar.Calendar(calendarElem, {
          initialView: 'dayGridMonth',
          locale: 'de',
          firstDay: 1,
          initialDate: #{data.Days[0].Day.Format("2006-01-02")},
          buttonText: {today: 'Heute'},
          height: '85%',
          eventSources: [
              {id: 'applied', events: []},
              {id: 'same_department', events: []},
              {id: 'total', events: []},
          ],
          dateClick: function(info) {
              if (info.date.getTime() < data[0].day.getTime() ||
                    info.date.getTime() > data[data.length - 1].day.getTime()) {
                  return;
              }

              const day = data.find(d => d.day.getTime() == info.date.getTime());

              modalTitle.innerText = day.day.toLocalDateString(
                  {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

              modalBody.innerHTML = '';

              for (const a of day.applications) {
                  const row = document.createElement('tr');
                  const name = document.createElement('td');
                  const department = document.createElement('td');
                  const email = document.createElement('td');

                  name.innerText = a.name;
                  department.innerText = a.department;
                  email.innerText = a.email;

                  row.appendChild(name);
                  row.appendChild(department);
                  row.appendChild(email);

                  modalBody.appendChild(row);
              }

              modal.classList.add('modal--active');
          }),
      })

      calendar.render();

      for (const day of data) {
          if (day.applied > 0) {
              calendar.addEvent({
                  title: day.applied == 0.5 ? '1/2 Beantragt' : 'Beantragt',
                  start: day.day,
                  end: day.day,
              }, 'applied');
          }

          let departmentApplications = 0;

          for (const application of day.applications) {
              if (application.department === "#{data.Self.Department}") {
                  departmentApplications++;
              }
          }

          if (departmentApplications > 0) {
              calendar.addEvent({
                  title: departmentApplications + " aus #{data.Self.Department}",
                  start: day.day,
                  end: day.day,
              }, 'same_department');
          }

          calendar.addEvent({
              title: day.applications.length + " insgesamt",
              start: day.day,
              end: day.day,
          }, 'total');
      }

  header.page-header
    h2 Antrag von #{morefmt.EmployeeName(data.Self)}

    +menu.Menu(size="big")
      block right
        li
          +button.Button(variant="red", type="submit", icon="la-times")>
            | Ablehnen

          +modal.Modal(id="deny-modal", size="sm")>
            header.modal-header
              h3 Ablehnen
            p Bitte nenne Sie einen Grund fÃ¼r die Ablehnung.
            +form.Form(action="/vacations/applications/"+data.ID.String()+"/deny", method="post")
              block
                textarea.width--100(id="reason", name="reason", rows="10", wrap="soft")
              block menu
                li
                  +button.Button(variant="outline", type="reset")>
                    | Abbrechen
                  +button.Button(variant="red", type="submit", icon="la-times")>
                    | Ablehnen
        li
          +form.Form(action="/vacations/applications/"+data.ID.String()+"/approve", method="post")>
            +button.Button(variant="green", type="submit", icon="la-check")>
              | Annehmen

  #calendar
  +modal.Modal(id="details-modal", size="big")>
    header
      h3#details-modal-title
    +table.HorizontalSepTable>
      thead
        tr
          th Name
          th Email
      tbody#details-modal-body